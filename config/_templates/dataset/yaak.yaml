#@yaml/text-templated-strings

#@ drives = [
#@     'Niro098-HQ/2024-06-18--13-39-54',
#@ ]

#@ cameras = [
#@     'cam_front_left',
#@     'cam_left_backward',
#@     'cam_right_backward',
#@ ]
---
_target_: rbyte.Dataset
_recursive_: false
_convert_: all
inputs:
  #@ for input_id in drives:
  (@=input_id@):
    sources:
      #@ for source_id in cameras:
      (@=source_id@):
        index_column: "meta/ImageMetadata.(@=source_id@)/frame_idx"
        source:
          _target_: rbyte.io.FfmpegFrameSource
          _recursive_: true
          path: "${data_dir}/(@=input_id@)/(@=source_id@).pii.mp4"
          resize_shorter_side: 324
      #@ end

    table_builder:
      _target_: rbyte.io.TableBuilder
      _convert_: all
      readers:
        meta:
          path: ${data_dir}/(@=input_id@)/metadata.log
          reader:
            _target_: rbyte.io.YaakMetadataTableReader
            _recursive_: false
            fields:
              rbyte.io.yaak.proto.sensor_pb2.ImageMetadata:
                time_stamp:
                  _target_: polars.Datetime
                  time_unit: ns

                frame_idx: polars.Int32
                camera_name:
                  _target_: polars.Enum
                  categories:
                    - cam_front_center
                    - cam_front_left
                    - cam_front_right
                    - cam_left_forward
                    - cam_right_forward
                    - cam_left_backward
                    - cam_right_backward
                    - cam_rear

              rbyte.io.yaak.proto.can_pb2.VehicleMotion:
                time_stamp:
                  _target_: polars.Datetime
                  time_unit: ns

                speed: polars.Float32
                gear:
                  _target_: polars.Enum
                  categories: ["0", "1", "2", "3"]

        mcap:
          path: ${data_dir}/(@=input_id@)/ai.mcap
          reader:
            _target_: rbyte.io.McapTableReader
            _recursive_: false
            decoder_factories: [rbyte.utils.mcap.ProtobufDecoderFactory]
            fields:
              /ai/safety_score:
                clip.end_timestamp:
                  _target_: polars.Datetime
                  time_unit: ns

                score: polars.Float32

      merger:
        _target_: rbyte.io.TableAligner
        separator: "/"
        merge:
          meta:
            ImageMetadata.(@=cameras[0]@):
              key: time_stamp

            #@ for camera in cameras[1:]:
            ImageMetadata.(@=camera@):
              key: time_stamp
              columns:
                frame_idx:
                  method: asof
                  tolerance: 20ms
                  strategy: nearest
            #@ end

            VehicleMotion:
              key: time_stamp
              columns:
                speed:
                  method: interp
                gear:
                  method: asof
                  tolerance: 100ms
                  strategy: nearest

          mcap:
            /ai/safety_score:
              key: clip.end_timestamp
              columns:
                clip.end_timestamp:
                  method: asof
                  tolerance: 500ms
                  strategy: nearest
                score:
                  method: asof
                  tolerance: 500ms
                  strategy: nearest

      filter: |
        `meta/VehicleMotion/gear` == '3'

      cache:
        _target_: rbyte.utils.dataframe.DataframeDiskCache
        directory: /tmp/rbyte-cache
        size_limit: 1GiB
  #@ end

sample_builder:
  _target_: rbyte.FixedWindowSampleBuilder
  index_column: meta/ImageMetadata.(@=cameras[0]@)/frame_idx
  every: 6i
  period: 6i
  filter: |
    array_length(`meta/ImageMetadata.(@=cameras[0]@)/time_stamp`) == 6
    and array_mean(`meta/VehicleMotion/speed`) > 40
